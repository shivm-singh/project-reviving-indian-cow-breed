<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Details</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .detail-header {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .role-owner {
            color: #28a745;
        }
        .role-worker {
            color: #17a2b8;
        }
        .role-manager {
            color: #ffc107;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #28a745;
        }
        .member-image {
            max-height: 300px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="index.html">Farm Management</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cows.html">Cows</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="members.html">Members</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div id="loadingIndicator" class="text-center my-5">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading member details...</p>
        </div>

        <div id="memberDetails" style="display: none;">
            <div class="detail-header">
                <div class="row">
                    <div class="col-md-4">
                        <img src="https://images.unsplash.com/photo-1582213782179-e0d53f98f2ca" alt="Member Image" class="img-fluid member-image rounded">
                    </div>
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h1 id="memberName"></h1>
                                <h4 class="mb-3" id="memberRole"></h4>
                            </div>
                            <div>
                                <a href="#" id="editMemberBtn" class="btn btn-outline-primary">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Member ID:</strong> <span id="memberId"></span></p>
                                <p><strong>Email:</strong> <span id="email"></span></p>
                                <p><strong>Phone:</strong> <span id="phone"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Join Date:</strong> <span id="joinDate"></span></p>
                                <p><strong>Address:</strong> <span id="address"></span></p>
                                <p><strong>Salary:</strong> <span id="salary"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs mb-4" id="memberTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button">Details</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cows-tab" data-bs-toggle="tab" data-bs-target="#cows" type="button">Assigned Cows</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button">Tasks</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button">Notes</button>
                </li>
            </ul>

            <div class="tab-content" id="memberTabContent">
                <div class="tab-pane fade show active" id="details" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Personal Information</h4>
                            <table class="table">
                                <tr>
                                    <th>Date of Birth</th>
                                    <td id="dob"></td>
                                </tr>
                                <tr>
                                    <th>Gender</th>
                                    <td id="gender"></td>
                                </tr>
                                <tr>
                                    <th>Emergency Contact</th>
                                    <td id="emergencyContact"></td>
                                </tr>
                                <tr>
                                    <th>Emergency Phone</th>
                                    <td id="emergencyPhone"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h4>Employment Information</h4>
                            <table class="table">
                                <tr>
                                    <th>Position</th>
                                    <td id="position"></td>
                                </tr>
                                <tr>
                                    <th>Salary Type</th>
                                    <td id="salaryType"></td>
                                </tr>
                                <tr>
                                    <th>Work Schedule</th>
                                    <td id="workSchedule"></td>
                                </tr>
                                <tr>
                                    <th>Benefits</th>
                                    <td id="benefits"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="cows" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Tag Number</th>
                                    <th>Name</th>
                                    <th>Breed</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assignedCowsTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="tasks" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Current Tasks</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Task</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="currentTasksTable">
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h4>Completed Tasks</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Task</th>
                                        <th>Completed On</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="completedTasksTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="notes" role="tabpanel">
                    <div class="mb-3">
                        <textarea class="form-control" id="memberNotes" rows="5"></textarea>
                    </div>
                    <button class="btn btn-success" id="saveNotesBtn">
                        <i class="bi bi-save"></i> Save Notes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3">
        <div class="container">
            <p>&copy; 2023 Farm Management System</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="scripts/member-service.js"></script>
    <script src="scripts/cow-service.js"></script>
    <script src="scripts/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get member ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const memberId = urlParams.get('id');

            if (!memberId) {
                window.location.href = 'members.html';
                return;
            }

            // Load member data
            const member = MemberService.getMemberById(memberId);
            
            if (!member) {
                document.getElementById('loadingIndicator').innerHTML = `
                    <div class="alert alert-danger">
                        Member not found. <a href="members.html">Return to member list</a>
                    </div>
                `;
                return;
            }

            // Display member data
            displayMemberDetails(member);

            // Setup edit button
            document.getElementById('editMemberBtn').href = `add-member.html?id=${member.id}`;

            // Setup notes save button
            document.getElementById('saveNotesBtn').addEventListener('click', function() {
                member.notes = document.getElementById('memberNotes').value;
                MemberService.updateMember(member);
                showAlert('Notes saved successfully!', 'success');
            });
        });

        function displayMemberDetails(member) {
            // Hide loading, show content
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('memberDetails').style.display = 'block';

            // Basic info
            document.getElementById('memberName').textContent = member.name;
            
            const roleClass = `role-${member.role}`;
            document.getElementById('memberRole').innerHTML = `
                <span class="${roleClass}">
                    <i class="bi ${getRoleIcon(member.role)}"></i> ${capitalizeFirstLetter(member.role)}
                </span>
            `;
            
            document.getElementById('memberId').textContent = member.id;
            document.getElementById('email').textContent = member.email || 'N/A';
            document.getElementById('phone').textContent = member.phone || 'N/A';
            document.getElementById('joinDate').textContent = formatDate(member.joinDate) || 'N/A';
            document.getElementById('address').textContent = member.address || 'N/A';
            document.getElementById('salary').textContent = member.salary ? `$${member.salary.toLocaleString()}` : 'N/A';

            // Personal info
            document.getElementById('dob').textContent = formatDate(member.dateOfBirth) || 'N/A';
            document.getElementById('gender').textContent = member.gender || 'N/A';
            document.getElementById('emergencyContact').textContent = member.emergencyContact || 'N/A';
            document.getElementById('emergencyPhone').textContent = member.emergencyPhone || 'N/A';

            // Employment info
            document.getElementById('position').textContent = member.position || 'N/A';
            document.getElementById('salaryType').textContent = member.salaryType || 'N/A';
            document.getElementById('workSchedule').textContent = member.workSchedule || 'N/A';
            document.getElementById('benefits').textContent = member.benefits || 'N/A';

            // Assigned cows
            populateAssignedCows(member.id);

            // Tasks
            populateTasks(member.id);

            // Notes
            document.getElementById('memberNotes').value = member.notes || '';
        }

        function getRoleIcon(role) {
            switch(role) {
                case 'owner': return 'bi-person-check-fill';
                case 'worker': return 'bi-person-badge';
                case 'manager': return 'bi-person-gear';
                default: return 'bi-person';
            }
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        function populateAssignedCows(memberId) {
            const cows = CowService.getCowsByOwner(memberId);
            const table = document.getElementById('assignedCowsTable');
            
            if (cows.length === 0) {
                table.innerHTML = '<tr><td colspan="5" class="text-center">No cows assigned to this member</td></tr>';
                return;
            }
            
            cows.forEach(cow => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cow.tagNumber}</td>
                    <td>${cow.name}</td>
                    <td>${cow.breed}</td>
                    <td><span class="badge ${getStatusBadgeClass(cow.status)}">${capitalizeFirstLetter(cow.status)}</span></td>
                    <td>
                        <a href="cow-detail.html?id=${cow.id}" class="btn btn-sm btn-outline-success">
                            View
                        </a>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'active': return 'bg-success';
                case 'sold': return 'bg-secondary';
                case 'deceased': return 'bg-danger';
                default: return 'bg-info';
            }
        }

        function populateTasks(memberId) {
            // This would be more complex in a real app with actual data
            // For demo purposes, we'll create some sample data
            
            // Current tasks
            const currentTasksTable = document.getElementById('currentTasksTable');
            const currentTasks = generateSampleTasks(3, false);
            
            currentTasks.forEach(task => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.description}</td>
                    <td>${task.dueDate}</td>
                    <td><span class="badge bg-warning">${task.status}</span></td>
                `;
                currentTasksTable.appendChild(row);
            });
            
            // Completed tasks
            const completedTasksTable = document.getElementById('completedTasksTable');
            const completedTasks = generateSampleTasks(2, true);
            
            completedTasks.forEach(task => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.description}</td>
                    <td>${task.completedDate}</td>
                    <td><span class="badge bg-success">${task.status}</span></td>
                `;
                completedTasksTable.appendChild(row);
            });
        }

        function generateSampleTasks(count, completed) {
            const tasks = [];
            const taskTypes = [
                'Milking', 'Feeding', 'Cleaning', 'Health Check', 
                'Vaccination', 'Breeding', 'Record Keeping'
            ];
            
            for (let i = 0; i < count; i++) {
                const task = {
                    description: `${taskTypes[i % taskTypes.length]} ${i + 1}`,
                    dueDate: getRandomFutureDate(),
                    status: completed ? 'Completed' : 'Pending'
                };
                
                if (completed) {
                    task.completedDate = getRandomPastDate();
                }
                
                tasks.push(task);
            }
            
            return tasks;
        }

        function getRandomFutureDate() {
            const today = new Date();
            const futureDate = new Date(today);
            futureDate.setDate(futureDate.getDate() + Math.floor(Math.random() * 30) + 1);
            return futureDate.toLocaleDateString();
        }

        function getRandomPastDate() {
            const today = new Date();
            const pastDate = new Date(today);
            pastDate.setDate(pastDate.getDate() - Math.floor(Math.random() * 30) + 1);
            return pastDate.toLocaleDateString();
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.role = 'alert';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            container.prepend(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 3000);
        }
    </script>
</body>
</html>